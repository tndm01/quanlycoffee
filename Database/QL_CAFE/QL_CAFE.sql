USE MASTER
GO
IF EXISTS (SELECT NAME FROM ..SYSDATABASES WHERE NAME ='QL_CAFE' )
	DROP DATABASE QL_CAFE
GO	
CREATE DATABASE QL_CAFE
GO
USE QL_CAFE

--TẠO CÁC BẢNG
CREATE TABLE DANGNHAP
(
	MANV CHAR(10),
	TENDN NVARCHAR(30),
	QUYEN NVARCHAR (30),
	CONSTRAINT PK_DANGNHAP PRIMARY KEY (TENDN,MANV)
)
GO

CREATE TABLE NHANVIEN
(
	MANV CHAR(10),
	TENNV NVARCHAR(30),
	DIACHI NVARCHAR(50),
	STD VARCHAR(15),
	GIOITINH NVARCHAR(5),
	NGAYSINH DATETIME,
	NGAYVAOLAM DATETIME NULL,
	SONGAYLAM INT NULL,
	LUONGCOBAN FLOAT,
	CA NVARCHAR(30) NULL,
	MAKV CHAR(10) NULL,
	CONSTRAINT PK_NHANVIEN PRIMARY KEY (MANV)
)
GO

CREATE TABLE KHUVUC
(
	MAKV CHAR(10),
	TENKV NVARCHAR(30),
	CONSTRAINT PK_KHUVUC PRIMARY KEY(MAKV)
)
GO

CREATE TABLE BAN
(
	MABAN CHAR(10),
	TENBAN NVARCHAR(30),
	SONGUOI INT,
	MAKV CHAR(10),
	CONSTRAINT PK_BAN PRIMARY KEY(MABAN)
)
GO

CREATE TABLE CHAMCONG 
(
	STT INT ,
	MANV CHAR(10),
	NGAY DATETIME,
	SOCA INT NULL,
	CONSTRAINT PK_CHAMCONG PRIMARY KEY (STT)
)
GO

CREATE TABLE LOAIMON
(
	MALOAI CHAR(10),
	TENLOAI NVARCHAR(30),
	CONSTRAINT PK_LOAIMON PRIMARY KEY (MALOAI)
)
GO

CREATE TABLE THUCDON
(
	MAMON CHAR(10),
	TENMON NVARCHAR(30),
	MALOAI CHAR(10),
	DONGIA FLOAT,
	DVT NVARCHAR(30) NULL , 
	SLN INT NULL, 
	SLT INT NULL,
	CONSTRAINT PK_THUCDON PRIMARY KEY (MAMON)
	
)
GO

CREATE TABLE NGUYENLIEU
(
	STT INT NULL,
	MANL CHAR(10),
	TENNL NVARCHAR(30),
	SOLUONG INT,
	DVT NVARCHAR(30),
	NGAYNHAP DATETIME NULL,
	CONSTRAINT PK_NGUYENLIEU PRIMARY KEY (MANL)
)

GO
CREATE TABLE CONGTHUC
(
	STT INT,
	MAMON CHAR(10),
	MANL CHAR (10),
	HAMLUONG FLOAT,
	TONG FLOAT,
)
GO

CREATE TABLE PHIEU
(
	MAPHIEU INT IDENTITY(1,1),
	MABAN CHAR(10),
	NGAYLAP DATETIME,
	TONGTIEN FLOAT NULL,
	CONSTRAINT PK_PHIEU PRIMARY KEY(MAPHIEU)
)

GO

CREATE TABLE CHITIETPHIEU
(
	MACTP INT IDENTITY(1,1),
	MAPHIEU INT,
	MAMON CHAR(10),
	GIAMGIA FLOAT,
	SOLUONG INT,
	TIEN FLOAT,
	CONSTRAINT PK_CHITIETPHIEU PRIMARY KEY (MACTP)
)

--TẠO KHÓA NGOẠI

--ĐĂNG NHẬP VÀ NHÂN VIÊN
ALTER TABLE DANGNHAP
ADD
	CONSTRAINT FK_DANGNHAP_NHANVIEN FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV)

--NHÂN VIÊN VÀ KHU VỰC	
ALTER TABLE NHANVIEN
ADD
	CONSTRAINT FK_NHANVIEN_KHUVUC FOREIGN KEY (MAKV) REFERENCES KHUVUC(MAKV)
	
--CHẤM CÔNG VÀ NHÂN VIÊN

ALTER TABLE CHAMCONG
ADD
	CONSTRAINT FK_CHAMCONG_NHANVIEN FOREIGN KEY (MANV) REFERENCES NHANVIEN(MANV) 
	
--BÀN VÀ KHU VỰC

ALTER TABLE BAN
ADD
	CONSTRAINT FK_BAN_KHUVUC FOREIGN KEY(MAKV) REFERENCES KHUVUC(MAKV)
	
--PHIẾU VÀ BÀN 

ALTER TABLE PHIEU
ADD
	CONSTRAINT FK_PHIEU_BAN FOREIGN KEY(MABAN) REFERENCES BAN(MABAN)

--CHI TIẾT PHIẾU PHIẾU

ALTER TABLE CHITIETPHIEU
ADD 
	CONSTRAINT FK_CHITIETPHIEU_PHIEU FOREIGN KEY(MAPHIEU) REFERENCES PHIEU(MAPHIEU)

--CHI TIẾT PHIẾU VÀ THỰC ĐƠN

ALTER TABLE CHITIETPHIEU
ADD
	CONSTRAINT FK_CHIEUTIETPHIEU_THUCDON FOREIGN KEY(MAMON) REFERENCES THUCDON(MAMON)
	
--MÓN VÀ THỰC ĐƠN

ALTER TABLE THUCDON
ADD
	CONSTRAINT FK_LOAIMON_THUCDON FOREIGN KEY (MALOAI) REFERENCES LOAIMON(MALOAI)
	
--CÔNG THỨC VÀ THỰC ĐƠN

ALTER TABLE CONGTHUC
ADD
	CONSTRAINT FK_CONGTHUC_THUCDON FOREIGN KEY (MAMON) REFERENCES THUCDON(MAMON)
	
--NGUYÊN LIỆU VÀ CÔNG THỨC

ALTER TABLE CONGTHUC
ADD 
	CONSTRAINT FK_NGUYENLIEU_CONGTHUC FOREIGN KEY (MANL) REFERENCES NGUYENLIEU(MANL)
	

--NHẬP LIỆU DỮ LIỆU

INSERT INTO NHANVIEN(MANV,TENNV,DIACHI,STD,GIOITINH,NGAYSINH,NGAYVAOLAM,SONGAYLAM,LUONGCOBAN,CA)
VALUES('NV01',N'NHÂN',N'LONG HẢI','01887151377',N'NAM','12/25/1995','1/1/2010','30','20000',N'CA TỐI')

INSERT INTO NHANVIEN(MANV,TENNV,DIACHI,STD,GIOITINH,NGAYSINH,NGAYVAOLAM,SONGAYLAM,LUONGCOBAN,CA)
VALUES('NV02',N'SƠN',N'QUẬN 1','0909301453',N'NAM','11/20/1995','1/1/2010','30','20000',N'CA SÁNG')

INSERT INTO NHANVIEN(MANV,TENNV,DIACHI,STD,GIOITINH,NGAYSINH,NGAYVAOLAM,SONGAYLAM,LUONGCOBAN,CA)
VALUES('NV03',N'NHƯ',N'BẾN TRE','9090906422',N'NỮ','9/30/1995','1/1/2010','30','20000',N'CA TỐI')

INSERT INTO NHANVIEN(MANV,TENNV,DIACHI,STD,GIOITINH,NGAYSINH,NGAYVAOLAM,SONGAYLAM,LUONGCOBAN,CA)
VALUES('NV04',N'PHÚC',N'QUẬN 7','09091234567',N'NAM','1/30/1995','1/1/2010','30','20000',N'CA SÁNG')

INSERT INTO NHANVIEN(MANV,TENNV,DIACHI,STD,GIOITINH,NGAYSINH,NGAYVAOLAM,SONGAYLAM,LUONGCOBAN,CA)
VALUES('NV05',N'NHƯ',N'QUẬN 3','09093334444',N'NỮ','3/30/1995','1/1/2010','30','20000',N'CA TỐI')

INSERT INTO NHANVIEN(MANV,TENNV,DIACHI,STD,GIOITINH,NGAYSINH,NGAYVAOLAM,SONGAYLAM,LUONGCOBAN,CA)
VALUES('NV06',N'TUỆ',N'QUẬN 7','01771626378',N'NAM','7/3/1995','1/1/2010','30','20000',N'CA SÁNG')

INSERT INTO NHANVIEN(MANV,TENNV,DIACHI,STD,GIOITINH,NGAYSINH,NGAYVAOLAM,SONGAYLAM,LUONGCOBAN,CA)
VALUES('NV07',N'VÂN',N'QUẬN 10','09091234567',N'NAM','1/30/1995','1/1/2010','30','20000',N'CA TỐI')

--NHẬP DỮ LIỆU TABLE KHU VỰC
SELECT * FROM KHUVUC

INSERT INTO KHUVUC
VALUES('KV01',N'SÂN VƯỜN')

INSERT INTO KHUVUC
VALUES('KV02',N'TẦNG TRỆT')

INSERT INTO KHUVUC
VALUES('KV03',N'TẦNG 1')

INSERT INTO KHUVUC
VALUES('KV04',N'TẦNG 2')

INSERT INTO KHUVUC
VALUES('KV05',N'TẦNG 3')

INSERT INTO KHUVUC
VALUES('KV06',N'TẦNG 4')

INSERT INTO KHUVUC
VALUES('KV07',N'SÂN THƯỢNG')

--NHẬP DỮ LIỆU TABLE BÀN

SELECT * FROM BAN

INSERT INTO BAN
VALUES('B01',N'BÀN 1','10','KV01')

INSERT INTO BAN
VALUES('B02',N'BÀN 2','10','KV02')

INSERT INTO BAN
VALUES('B03',N'BÀN 3','10','KV03')

INSERT INTO BAN
VALUES('B04',N'BÀN 4','10','KV01')

INSERT INTO BAN
VALUES('B05',N'BÀN 5','10','KV01')

INSERT INTO BAN
VALUES('B06',N'BÀN 6','10','KV02')

INSERT INTO BAN
VALUES('B07',N'BÀN 7','10','KV03')


--THÊM DỮ LIỆU TABLE LOAIMON
SELECT * FROM LOAIMON

INSERT INTO LOAIMON
VALUES('ML01',N'NƯỚC')

INSERT INTO LOAIMON
VALUES('ML02',N'KEM')

INSERT INTO LOAIMON
VALUES('ML03',N'THỨC ĂN')

--THÊM DỮ LIỆU THUCDON
SELECT * FROM THUCDON

INSERT INTO THUCDON
VALUES('MM01',N'CAFE SỮA','ML01','10000',N'LY',100,69)

INSERT INTO THUCDON
VALUES('MM02',N'CAFE ĐÁ','ML01','12000',N'LY',100,79)

INSERT INTO THUCDON
VALUES('MM03',N'CƠM GÀ','ML03','20000',N'ĐĨA',100,99)

INSERT INTO THUCDON
VALUES('MM04',N'TRÀ XANH','ML01','8000',N'CHAI',100,99)

INSERT INTO THUCDON
VALUES('MM05',N'KEM SOCOLA','ML02','7500',N'CÂY',100,97)

INSERT INTO THUCDON
VALUES('MM06',N'NƯỚC CAM','ML01','15000',N'CHAI',100,100)

INSERT INTO THUCDON
VALUES('MM07',N'KEM DÂU','ML02','15000',N'LY',100,100)	

INSERT INTO THUCDON
VALUES('MM08',N'CƠM XƯỜN','ML03','15000',N'ĐĨA',100,100)	

INSERT INTO THUCDON
VALUES('MM09',N'BÒ BÍA','ML03','15000',N'ĐĨA',100,100)	

--THÊM DỮ LIỆU BẢNG CHAMCONG

INSERT INTO CHAMCONG
VALUES('1','NV01','6/15/2012',2)

INSERT INTO CHAMCONG
VALUES('2','NV02','6/20/2012',3)

INSERT INTO CHAMCONG
VALUES('3','NV03','6/4/2012',1)

INSERT INTO CHAMCONG
VALUES('4','NV04','6/10/2012',2)

INSERT INTO CHAMCONG
VALUES('5','NV05','6/25/2012',3)

INSERT INTO CHAMCONG
VALUES('6','NV06','6/30/2012',1)

INSERT INTO CHAMCONG
VALUES('7','NV07','6/7/2012',3)



--THÊM DỮ LIỆU TABLE NGUYENLIEU

INSERT INTO NGUYENLIEU (MANL,TENNL,SOLUONG,DVT,NGAYNHAP)
VALUES('NL01',N'CAFE','5','KG','3/4/2015')

INSERT INTO NGUYENLIEU (MANL,TENNL,SOLUONG,DVT,NGAYNHAP)
VALUES('NL02',N'ĐƯỜNG','10','KG','3/4/2015')

INSERT INTO NGUYENLIEU (MANL,TENNL,SOLUONG,DVT,NGAYNHAP)
VALUES('NL03',N'SỮA','20','KG','3/4/2015')

INSERT INTO NGUYENLIEU (MANL,TENNL,SOLUONG,DVT,NGAYNHAP)
VALUES('NL04',N'KEM','17','KG','3/4/2015')

INSERT INTO NGUYENLIEU (MANL,TENNL,SOLUONG,DVT,NGAYNHAP)
VALUES('NL05',N'BÁNH MÌ','50','KG','3/4/2015')

INSERT INTO NGUYENLIEU (MANL,TENNL,SOLUONG,DVT,NGAYNHAP)
VALUES('NL06',N'TRỨNG','35','KG','3/4/2015')

INSERT INTO NGUYENLIEU (MANL,TENNL,SOLUONG,DVT,NGAYNHAP)
VALUES('NL07',N'PATÊ','6','KG','3/4/2015')

INSERT INTO NGUYENLIEU (MANL,TENNL,SOLUONG,DVT,NGAYNHAP)
VALUES('NL08',N'SOCOLA','200','KG','3/4/2015')

INSERT INTO NGUYENLIEU (MANL,TENNL,SOLUONG,DVT,NGAYNHAP)
VALUES('NL09',N'TRÁI DÂU','80','KG','3/4/2015')

INSERT INTO NGUYENLIEU (MANL,TENNL,SOLUONG,DVT,NGAYNHAP)
VALUES('NL10',N'GẠO','200','KG','3/4/2015')

INSERT INTO NGUYENLIEU (MANL,TENNL,SOLUONG,DVT,NGAYNHAP)
VALUES('NL11',N'HỦ TÍU','27','KG','3/4/2015')

INSERT INTO NGUYENLIEU (MANL,TENNL,SOLUONG,DVT,NGAYNHAP)
VALUES('NL12',N'CHANH DÂY','10','KG','3/4/2015')

INSERT INTO NGUYENLIEU (MANL,TENNL,SOLUONG,DVT,NGAYNHAP)
VALUES('NL13',N'TRÁI BƠ','10','KG','3/4/2015')

INSERT INTO NGUYENLIEU (MANL,TENNL,SOLUONG,DVT,NGAYNHAP)
VALUES('NL14',N'BÁNH PHỞ','10','KG','3/4/2015')

--CÂU LỆNH TÍNH THỐNG KÊ PHIẾU XUẤT
SELECT P.MAPHIEU,P.MABAN,(TIEN)AS TONGTIEN 
FROM CHITIETPHIEU CT
LEFT JOIN THUCDON TD ON CT.MAMON = TD.MAMON
LEFT JOIN PHIEU P ON P.MAPHIEU = CT.MAPHIEU
where CT.MACTP = '1'

select * from BAN
select * from THUCDON

select TENMON,DONGIA,SOLUONG,DVT,GIAMGIA
from CHITIETPHIEU CT
LEFT JOIN THUCDON TD ON TD.MAMON = CT.MAMON
LEFT JOIN PHIEU P ON P.MAPHIEU = CT.MAPHIEU
WHERE CT.MAPHIEU = 'P001'

SELECT A.MACTP, C.MABAN,(TIEN) AS TONGTIEN  
from CHITIETPHIEU A 
LEFT JOIN THUCDON B on A.MAMON = B.MAMON 
LEFT JOIN PHIEU C ON A.MAPHIEU = C.MAPHIEU 
where A.MACTP = '1'


INSERT INTO PHIEU(MABAN,TONGTIEN)
VALUES ('B01','0')

-----------------------------------------
DECLARE @MyTableVar AS BIGINT
SELECT MAPHIEU, MABAN, TONGTIEN FROM PHIEU;

INSERT INTO PHIEU(MABAN, TONGTIEN)
VALUES ('B01', '0');

--Display the result set of the table variable.
SET @MyTableVar = @@IDENTITY



-------------------------------------------

SELECT * FROM CHITIETPHIEU
DECLARE @MACTP table( MACTP smallint,
                           MAMON CHAR(10),
                           GIAMGIA INT,
                           SOLUONG INT,
                           TIEN FLOAT);
INSERT INTO CHITIETPHIEU(MAMON,GIAMGIA,SOLUONG,TIEN)
VALUES ('M01',1,1,0);

--Display the result set of the table variable.
SELECT MACTP, MAMON, GIAMGIA, SOLUONG, TIEN FROM CHITIETPHIEU;
-----------------------------------------

select * from chitietphieu
SELECT * FROM PHIEU 

insert into PHIEU(MABAN,TONGTIEN)
values('b01','0')

INSERT INTO PHIEU (MABAN, TONGTIEN) VALUES ('B01','0')
